# 完整部署检查清单

## 前置准备
- [x] DNS解析已指向 154.94.235.178
- [x] 服务器防火墙开放端口：80, 443, 8062, 9000, 9001, 5672
- [x] MinIO已运行（154.94.235.178:9000, 9001）
- [x] RabbitMQ已运行（154.94.235.178:5672）
- [x] MySQL可访问（8.156.75.132:3306）
- [x] Redis可访问（8.156.75.132:6379）
- [x] 已修改application.yml中的Quartz数据源地址
- [x] 已在nginx主配置添加WebSocket支持

## 部署步骤

### 1. SSL证书申请
```bash
# 参考文档：01-SSL证书申请.md
certbot certonly --webroot -w /data/nginx/html \
  -d haikari.top -d www.haikari.top \
  -d sherry.haikari.top -d blog.admin.haikari.top -d minio.haikari.top \
  --email Haibara406@gmail.com --agree-tos --non-interactive
```
- [ ] 证书申请成功
- [ ] 证书已复制到 /data/nginx/ssl
- [ ] 设置自动续期

### 2. Nginx配置
```bash
# 参考文档：02-Nginx配置.md
vim /data/nginx/conf/conf.d/blog.conf
docker exec nginx nginx -t
docker restart nginx
```
- [ ] 配置文件已创建
- [ ] 配置测试通过
- [ ] Nginx已重启

### 3. 后端部署
```bash
# 参考文档：03-后端部署流程.md
# 本地构建镜像
cd blog-backend
docker build -t haibara-blog-backend:latest .
docker save -o haibara-blog-backend.tar haibara-blog-backend:latest
scp haibara-blog-backend.tar root@154.94.235.178:/root/

# 服务器加载运行
docker load -i /root/haibara-blog-backend.tar
docker run -d --name haibara-blog-backend -p 8062:8062 \
  -e SPRING_PROFILES_ACTIVE=prod -v /app/logs:/app/logs \
  --restart unless-stopped haibara-blog-backend:latest
```
- [ ] Docker镜像构建成功
- [ ] 容器启动成功
- [ ] 日志无错误

### 4. 前端部署
```bash
# 构建前端项目
cd 前端项目目录
npm run build

# 上传到服务器
# 管理端
scp -r dist/* root@154.94.235.178:/data/nginx/html/admin/

# 前台博客
scp -r dist/* root@154.94.235.178:/data/nginx/html/blog/

# 主站（如有）
scp -r dist/* root@154.94.235.178:/data/nginx/html/
```
- [ ] 管理端前端已部署
- [ ] 前台博客前端已部署
- [ ] 主站前端已部署

## 功能验证

### 服务访问测试
```bash
# 后端健康检查
curl http://154.94.235.178:8062/actuator/health

# 通过nginx访问后端
curl https://haikari.top/api/public/test

# MinIO访问
curl https://minio.haikari.top
```
- [ ] 后端健康检查通过
- [ ] 后端API可访问
- [ ] MinIO控制台可访问

### 域名访问测试
- [ ] https://haikari.top 可访问
- [ ] https://sherry.haikari.top 可访问
- [ ] https://blog.admin.haikari.top 可访问
- [ ] https://minio.haikari.top 可访问
- [ ] HTTP自动跳转HTTPS

### 功能测试
- [ ] 用户登录功能正常
- [ ] 文章列表加载正常
- [ ] 图片显示正常（MinIO）
- [ ] 评论功能正常
- [ ] 第三方登录正常（Gitee/GitHub）
- [ ] 邮件发送正常
- [ ] 后台管理功能正常

### 数据库连接测试
```bash
# 进入后端容器测试
docker exec -it haibara-blog-backend sh

# 查看日志中的数据库连接信息
docker logs haibara-blog-backend | grep -i mysql
docker logs haibara-blog-backend | grep -i redis
```
- [ ] MySQL连接正常
- [ ] Redis连接正常
- [ ] RabbitMQ连接正常

## 监控和日志

### 日志查看
```bash
# Nginx日志
docker logs nginx
tail -f /data/nginx/logs/access.log
tail -f /data/nginx/logs/error.log

# 后端日志
docker logs -f haibara-blog-backend
tail -f /app/logs/spring.log
```
- [ ] Nginx日志正常
- [ ] 后端日志无ERROR

### 性能监控
```bash
# 查看容器资源使用
docker stats

# 查看系统资源
htop
df -h
```
- [ ] 容器资源使用正常
- [ ] 系统资源充足

## 安全检查
- [ ] SSL证书有效
- [ ] 仅必要端口对外开放
- [ ] 数据库仅内网访问
- [ ] Redis设置密码保护
- [ ] RabbitMQ设置密码保护

## 备份计划
- [ ] 数据库定期备份
- [ ] MinIO数据定期备份
- [ ] 配置文件备份
- [ ] SSL证书备份

## 问题排查

### 后端无法启动
1. 检查日志：`docker logs haibara-blog-backend`
2. 检查MySQL连接：确认8.156.75.132:3306可访问
3. 检查Redis连接：确认8.156.75.132:6379可访问
4. 检查RabbitMQ连接：确认154.94.235.178:5672可访问

### 前端白屏
1. 检查nginx配置：`docker exec nginx nginx -t`
2. 检查前端文件：`ls -la /data/nginx/html/`
3. 检查nginx日志：`tail -f /data/nginx/logs/error.log`

### SSL证书问题
1. 检查证书文件：`ls -la /data/nginx/ssl/`
2. 检查证书有效期：`openssl x509 -in /data/nginx/ssl/haikari.top.crt -noout -dates`
3. 重新申请证书：参考01-SSL证书申请.md

### 图片加载失败
1. 检查MinIO是否运行：`docker ps | grep minio`
2. 检查MinIO配置：确认bucketName为haibara-blog
3. 检查nginx代理：确认minio.haikari.top配置正确
4. 检查防火墙：确认9000和9001端口开放

