# 后端部署流程

## 方式一：本地构建镜像后上传（推荐）

### 本地操作
```bash
# 进入项目目录
cd /Users/haibara/Documents/java_program/haibara-blog-backend/blog-backend

# 构建Docker镜像
docker build -t haibara-blog-backend:latest .

# 保存镜像为tar文件
docker save -o haibara-blog-backend.tar haibara-blog-backend:latest

# 上传到服务器
scp haibara-blog-backend.tar root@154.94.235.178:/root/
```

### 服务器操作
```bash
# 加载镜像
docker load -i /root/haibara-blog-backend.tar

# 创建日志目录
mkdir -p /app/logs

# 启动容器
docker run -d \
  --name haibara-blog-backend \
  -p 8062:8062 \
  -e SPRING_PROFILES_ACTIVE=prod \
  -v /app/logs:/app/logs \
  --restart unless-stopped \
  --log-opt max-size=100m \
  --log-opt max-file=5 \
  haibara-blog-backend:latest

# 查看启动日志
docker logs -f haibara-blog-backend
```

---

## 方式二：服务器直接构建

### 上传代码
```bash
# 打包项目（排除target目录）
cd /Users/haibara/Documents/java_program/haibara-blog-backend
tar -czf blog-backend.tar.gz --exclude='blog-backend/target' blog-backend/

# 上传到服务器
scp blog-backend.tar.gz root@154.94.235.178:/root/
```

### 服务器构建
```bash
# 解压代码
cd /root
tar -xzf blog-backend.tar.gz
cd blog-backend

# 构建镜像
docker build -t haibara-blog-backend:latest .

# 创建日志目录
mkdir -p /app/logs

# 启动容器
docker run -d \
  --name haibara-blog-backend \
  -p 8062:8062 \
  -e SPRING_PROFILES_ACTIVE=prod \
  -v /app/logs:/app/logs \
  --restart unless-stopped \
  --log-opt max-size=100m \
  --log-opt max-file=5 \
  haibara-blog-backend:latest

# 查看启动日志
docker logs -f haibara-blog-backend
```

---

## 常用管理命令

```bash
# 查看容器状态
docker ps | grep haibara-blog-backend

# 查看实时日志
docker logs -f haibara-blog-backend

# 查看最近100行日志
docker logs --tail 100 haibara-blog-backend

# 重启容器
docker restart haibara-blog-backend

# 停止容器
docker stop haibara-blog-backend

# 删除容器
docker rm -f haibara-blog-backend

# 进入容器
docker exec -it haibara-blog-backend sh

# 查看容器资源使用
docker stats haibara-blog-backend
```

---

## 更新部署

```bash
# 停止并删除旧容器
docker stop haibara-blog-backend
docker rm haibara-blog-backend

# 删除旧镜像（可选）
docker rmi haibara-blog-backend:latest

# 重新构建或加载新镜像
# 然后重新运行启动命令
```

---

## 验证部署

```bash
# 检查端口监听
netstat -tlnp | grep 8062

# 测试健康检查接口
curl http://localhost:8062/actuator/health

# 测试API接口（需要根据实际情况调整）
curl http://localhost:8062/public/test

# 从外部测试（通过nginx）
curl https://haikari.top/api/public/test
```

---

## 排查问题

```bash
# 查看完整日志
docker logs haibara-blog-backend

# 查看容器详细信息
docker inspect haibara-blog-backend

# 检查网络连接
docker exec haibara-blog-backend ping -c 3 8.156.75.132

# 测试MySQL连接
docker exec haibara-blog-backend curl -I telnet://8.156.75.132:3306

# 测试Redis连接
docker exec haibara-blog-backend curl -I telnet://8.156.75.132:6379

# 进入容器查看
docker exec -it haibara-blog-backend sh
```

