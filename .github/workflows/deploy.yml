name: Backend CI/CD

on:
  push:
    branches: [ master, main ]
    paths:
      - 'blog-backend/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-deploy:
    name: ğŸš€ æ„å»ºå¹¶éƒ¨ç½²åç«¯
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: â˜• è®¾ç½® JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: ğŸ” ä»£ç æ£€æŸ¥
        run: |
          cd blog-backend
          mvn checkstyle:check || echo "âš ï¸ Checkstyleæ£€æŸ¥æœ‰è­¦å‘Šï¼Œç»§ç»­æ„å»º..."
        continue-on-error: true
      
      - name: ğŸ§ª è¿è¡Œæµ‹è¯•
        run: |
          cd blog-backend
          mvn test -Dspring.profiles.active=test || echo "âš ï¸ æµ‹è¯•æœ‰å¤±è´¥ï¼Œç»§ç»­æ„å»º..."
        continue-on-error: true
      
      - name: ğŸ”¨ Maven æ‰“åŒ…
        run: |
          cd blog-backend
          echo "å¼€å§‹Mavenæ‰“åŒ…..."
          mvn clean package -DskipTests -Pprod
          echo "âœ… Mavenæ‰“åŒ…å®Œæˆ"
          ls -lh target/*.jar
      
      - name: ğŸ” ç™»å½• DockerHub
        uses: docker/login-action@v3
        with:
          username: haibaraiii
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: ğŸ³ æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        run: |
          cd blog-backend
          
          # æ„å»ºé•œåƒ
          echo "å¼€å§‹æ„å»º Docker é•œåƒ..."
          docker build -t haibaraiii/blog-backend:latest .
          docker build -t haibaraiii/blog-backend:build-${{ github.run_number }} .
          
          # æ¨é€åˆ° DockerHub
          echo "æ¨é€é•œåƒåˆ° DockerHub..."
          docker push haibaraiii/blog-backend:latest
          docker push haibaraiii/blog-backend:build-${{ github.run_number }}
          
          echo "âœ… Dockeré•œåƒå·²æ¨é€"
          echo "é•œåƒæ ‡ç­¾: latest, build-${{ github.run_number }}"
      
      - name: ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 154.94.235.178
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "=========================================="
            echo "ğŸ”„ å¼€å§‹éƒ¨ç½² Haibara Blog åç«¯"
            echo "=========================================="
            
            # æ‹‰å–æœ€æ–°é•œåƒ
            echo "ğŸ“¦ æ‹‰å–æœ€æ–° Docker é•œåƒ..."
            docker pull haibaraiii/blog-backend:latest
            
            # åœæ­¢æ—§å®¹å™¨
            echo "ğŸ›‘ åœæ­¢æ—§å®¹å™¨..."
            docker stop haibara-blog-backend 2>/dev/null || echo "å®¹å™¨ä¸å­˜åœ¨æˆ–å·²åœæ­¢"
            docker rm haibara-blog-backend 2>/dev/null || echo "å®¹å™¨å·²åˆ é™¤"
            
            # å¯åŠ¨æ–°å®¹å™¨
            echo "ğŸš€ å¯åŠ¨æ–°å®¹å™¨..."
            docker run -d --name haibara-blog-backend -p 8066:8066 -v /app/logs:/app/logs -e SPRING_PROFILES_ACTIVE=prod -e SPRING_DATASOURCE_URL="jdbc:mysql://8.156.75.132:3306/haibara_blog?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Shanghai" -e SPRING_DATASOURCE_USERNAME=root -e SPRING_DATASOURCE_PASSWORD=Ww249260523.. -e SPRING_DATA_REDIS_HOST=8.156.75.132 -e SPRING_DATA_REDIS_PASSWORD=Ww249260523.. -e SPRING_RABBITMQ_HOST=154.94.235.178 -e SPRING_RABBITMQ_PASSWORD=Ww249260523.. --restart unless-stopped --log-opt max-size=100m --log-opt max-file=5 haibaraiii/blog-backend:latest
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼ˆ15ç§’ï¼‰..."
            sleep 15
            
            # æ£€æŸ¥å®¹å™¨çŠ¶æ€
            echo ""
            echo "ğŸ“Š å®¹å™¨çŠ¶æ€ï¼š"
            if docker ps | grep -q haibara-blog-backend; then
              echo "âœ… å®¹å™¨è¿è¡Œæ­£å¸¸"
              docker ps | grep haibara-blog-backend
            else
              echo "âŒ å®¹å™¨å¯åŠ¨å¤±è´¥ï¼æŸ¥çœ‹æ—¥å¿—ï¼š"
              docker logs --tail 50 haibara-blog-backend
              exit 1
            fi
            
            # å¥åº·æ£€æŸ¥
            echo ""
            echo "ğŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            for i in {1..10}; do
              if curl -f http://localhost:8066/actuator/health 2>/dev/null; then
                echo "âœ… æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
                curl -s http://localhost:8066/actuator/health | python3 -m json.tool || true
                break
              fi
              echo "â³ ç­‰å¾…æœåŠ¡å°±ç»ª... ($i/10)"
              sleep 3
            done
            
            # æ¸…ç†æ—§é•œåƒ
            echo ""
            echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
            docker image prune -f
            
            # æ˜¾ç¤ºæœ€å50è¡Œæ—¥å¿—
            echo ""
            echo "ğŸ“‹ åº”ç”¨æ—¥å¿—ï¼ˆæœ€å50è¡Œï¼‰ï¼š"
            docker logs --tail 50 haibara-blog-backend
            
            echo ""
            echo "=========================================="
            echo "ğŸ‰ åç«¯éƒ¨ç½²å®Œæˆï¼"
            echo "=========================================="
            echo "ğŸ”— è®¿é—®åœ°å€: http://154.94.235.178:8066"
            echo "ğŸ“š APIæ–‡æ¡£: http://154.94.235.178:8066/doc.html"
            echo "ğŸ¥ å¥åº·æ£€æŸ¥: http://154.94.235.178:8066/actuator/health"
      
      - name: ğŸ“Š ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
        if: always()
        run: |
          echo "## ğŸš€ åç«¯éƒ¨ç½²æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | ä¿¡æ¯ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“¦ é¡¹ç›®åç§° | Haibara Blog Backend |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ·ï¸ æ„å»ºå· | #${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸŒ¿ åˆ†æ”¯ | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ‘¤ æäº¤è€… | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“ æäº¤ä¿¡æ¯ | ${{ github.event.head_commit.message }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ³ Dockeré•œåƒ | haibaraiii/blog-backend:latest |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ–¥ï¸ æœåŠ¡å™¨ | 154.94.235.178:8066 |" >> $GITHUB_STEP_SUMMARY
          echo "| â° éƒ¨ç½²æ—¶é—´ | $(date '+%Y-%m-%d %H:%M:%S') |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“Š çŠ¶æ€ | ${{ job.status == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— å¿«é€Ÿé“¾æ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [APIæ–‡æ¡£](http://154.94.235.178:8066/doc.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [å¥åº·æ£€æŸ¥](http://154.94.235.178:8066/actuator/health)" >> $GITHUB_STEP_SUMMARY
          echo "- [DockerHub](https://hub.docker.com/r/haibaraiii/blog-backend)" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ“¢ éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "::notice title=éƒ¨ç½²æˆåŠŸ::âœ… Haibara Blog åç«¯å·²æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆæ„å»º #${{ github.run_number }}ï¼‰"
      
      - name: ğŸ“¢ éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "::error title=éƒ¨ç½²å¤±è´¥::âŒ Haibara Blog åç«¯éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"

